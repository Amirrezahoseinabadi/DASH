// =================================================================================
//         کد نهایی ربات جشنواره تابستانی - نسخه 29 (افزودن API کاربر و لینک اشتراک‌گذاری)
// =================================================================================

export default {
    async fetch(request, env, ctx) {
        const url = new URL(request.url);
        // Routing API requests
        if (url.pathname === '/api/leaderboard') {
            return await handleApiRequest(request, env);
        }
        if (url.pathname.startsWith('/api/user/')) {
            return await handleUserApiRequest(request, env);
        }

        // Handling Telegram updates
        try {
            const contentType = request.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                if (env.REAL_BOT_HOST_URL) {
                    ctx.waitUntil(forwardRawBody(request, "", env.REAL_BOT_HOST_URL));
                }
                return new Response('OK');
            }
            const rawBody = await request.text();
            if (!rawBody) return new Response('OK');
            if (env.REAL_BOT_HOST_URL) {
                ctx.waitUntil(forwardRawBody(request, rawBody, env.REAL_BOT_HOST_URL));
            }
            const update = JSON.parse(rawBody);
            const bot = new TelegramBot(env.BOT_TOKEN);
            if (update.channel_post) {
                await handleChannelPost(update.channel_post, env, bot);
            } else if (update.callback_query) {
                await handleCallbackQuery(update.callback_query, env, bot);
            } else if (update.message) {
                await handleMessage(update.message, env, bot);
            }
        } catch (e) {
            console.error("خطای بحرانی در پردازشگر اصلی:", e.toString());
        }
        return new Response('OK');
    },
    async scheduled(controller, env, ctx) {
        console.log("Cron Trigger: شروع به‌روزرسانی کش لیدربرد...");
        ctx.waitUntil(updateLeaderboardCache(env));
    }
};

async function handleUserApiRequest(request, env) {
    const url = new URL(request.url);
    const userId = url.pathname.split('/').pop();
    const headers = { 'Content-Type': 'application/json;charset=UTF-8', 'Access-Control-Allow-Origin': '*' };

    if (!userId || isNaN(userId)) {
        return new Response(JSON.stringify({ error: "User ID provided is invalid." }), { status: 400, headers });
    }

    const userData = await env.CONTEST_DB.get(`user_${userId}`, { type: 'json' });

    if (!userData) {
        return new Response(JSON.stringify({ error: "User not found." }), { status: 404, headers });
    }

    const cachedLeaderboard = await env.CONTEST_DB.get('leaderboard_cache', { type: 'json' });
    let rank = -1;
    if (cachedLeaderboard) {
        const userIndex = cachedLeaderboard.findIndex(u => u.id == userId);
        if (userIndex !== -1) {
            rank = userIndex + 1;
        }
    }

    const responseData = {
        id: userId,
        username: userData.username || null,
        first_name: userData.first_name || 'کاربر',
        points: userData.points || 0,
        rank: rank
    };

    return new Response(JSON.stringify(responseData), { status: 200, headers });
}


async function handleApiRequest(request, env) {
    const cachedLeaderboard = await env.CONTEST_DB.get('leaderboard_cache', { type: 'json' });
    if (!cachedLeaderboard) {
        return new Response(JSON.stringify({ error: "لیست نفرات برتر در حال حاضر در دسترس نیست. لطفاً چند دقیقه دیگر تلاش کنید." }), {
            status: 404,
            headers: { 'Content-Type': 'application/json;charset=UTF-8', 'Access-Control-Allow-Origin': '*' },
        });
    }
    return new Response(JSON.stringify(cachedLeaderboard), {
        status: 200,
        headers: { 'Content-Type': 'application/json;charset=UTF-8', 'Access-Control-Allow-Origin': '*', 'Cache-Control': 'public, max-age=60' },
    });
}

async function updateLeaderboardCache(env) {
    try {
        if (!env.CONTEST_DB) {
            throw new Error("دیتابیس (KV Namespace) با نام CONTEST_DB به درستی متصل نشده است.");
        }
        let allKeys = [];
        let listComplete = false;
        let cursor = undefined;
        while (!listComplete) {
            const result = await env.CONTEST_DB.list({ limit: 1000, cursor: cursor });
            allKeys = allKeys.concat(result.keys);
            listComplete = result.list_complete;
            cursor = result.cursor;
        }
        const promises = allKeys
            .filter(key => key.name.startsWith('user_'))
            .map(key =>
                env.CONTEST_DB.get(key.name, { type: 'json' })
                .then(value => (value && value.points > 0) ? {
                    id: key.name.replace('user_', ''),
                    username: value.username || null,
                    first_name: value.first_name || `کاربر`,
                    points: value.points || 0
                } : null)
                .catch(e => { console.error(`خطا در خواندن کلید ${key.name}: ${e.message}`); return null; })
            );
        const results = await Promise.all(promises);
        let users = results.filter(user => user !== null);
        users.sort((a, b) => b.points - a.points);
        const top100 = users.slice(0, 100);
        await env.CONTEST_DB.put('leaderboard_cache', JSON.stringify(top100));
        console.log(`کش لیدربرد با موفقیت به‌روز شد. (${top100.length} کاربر برتر ذخیره شدند)`);
        return { success: true, error: null };
    } catch (e) {
        console.error("خطای جدی در به‌روزرسانی کش لیدربرد:", e.toString());
        return { success: false, error: e.toString() };
    }
}

async function handleMessage(message, env, bot) {
    const userId = message.from.id;
    const username = message.from.username || `user_${userId}`;
    const firstName = message.from.first_name || `کاربر`;
    const text = message.text || '';
    
    let userData = await env.CONTEST_DB.get(`user_${userId}`, { type: 'json' }) || createDefaultUserData(username, firstName);
    let dataChanged = false;

    if (userData.username !== username || userData.first_name !== firstName) {
        userData.username = username;
        userData.first_name = firstName;
        dataChanged = true;
    }
    
    if (text === '/admin_update_cache') {
        if (userId.toString() === env.ADMIN_USER_ID) {
            await bot.sendMessage(userId, "⏳ در حال به‌روزرسانی دستی کش لیدربرد... لطفاً صبر کنید.");
            const { success, error } = await updateLeaderboardCache(env);
            if (success) {
                await bot.sendMessage(userId, "✅ کش لیدربرد با موفقیت به‌روز شد.");
            } else {
                await bot.sendMessage(userId, `❌ خطا در به‌روزرسانی کش:\n\n<code>${error}</code>`);
            }
        } else {
            await bot.sendMessage(userId, "شما اجازه دسترسی به این دستور را ندارید.");
        }
        return;
    }

    if (text === '/leaderboard') {
        const leaderboardUrl = `https://amirrezahoseinabadi.github.io/DASH?user_id=${userId}`; 
        const messageText = `🏆 برای مشاهده جدول کامل و به‌روز نفرات برتر، روی دکمه زیر کلیک کنید:`;
        const keyboard = {
            inline_keyboard: [
                [{ text: "🚀 باز کردن جدول نفرات برتر", web_app: { url: leaderboardUrl } }]
            ]
        };
        await bot.sendMessage(userId, messageText, keyboard);
        return;
    }

    if (text.startsWith('/start')) {
        const parts = text.split(' ');
        const startPayload = parts.length > 1 ? parts[1] : null;

        if (startPayload && startPayload == userId) {
            const funnyMessage = "داداش داری اشتباه میزنی! چرا قیمه‌ها رو می‌ریزی تو ماست‌ها؟ 🤔\n\nنمیشه که خودت زیرمجموعه خودت بشی! این لینک رو برای دوستات بفرست.";
            await bot.sendMessage(userId, funnyMessage);
            const welcomeMessage = "👇 برای دریافت لینک دعوت اختصاصی خود، روی دکمه زیر کلیک کنید.";
            const keyboard = { inline_keyboard: [ [{ text: "🔗 دریافت لینک دعوت", callback_data: "request_referral_link" }] ] };
            await bot.sendMessage(userId, welcomeMessage, keyboard);
        
        } else if (startPayload === 'promo_channel') {
                const promoMessage = "🎉 به کمپین ویژه ما از کانال خوش آمدید! 🎉\n\nبرای شرکت در قرعه‌کشی و دریافت لینک دعوت اختصاصی خود، روی دکمه زیر کلیک کنید.";
                const keyboard = { inline_keyboard: [ [{ text: "🔗 دریافت لینک دعوت", callback_data: "request_referral_link" }] ] };
                await bot.sendMessage(userId, promoMessage, keyboard);

        } else if (startPayload && !isNaN(startPayload) && !userData.referrer_id) {
                const referrerId = startPayload;
                let referrerData = await env.CONTEST_DB.get(`user_${referrerId}`, { type: 'json' }) || createDefaultUserData();
                
                referrerData.referrals_count = (referrerData.referrals_count || 0) + 1;
                await env.CONTEST_DB.put(`user_${referrerId}`, JSON.stringify(referrerData));
                
                userData.referrer_id = referrerId;
                dataChanged = true;
                
                const messageForReferrer = `👋 کاربر <b>${firstName}</b> دعوت شما را پذیرفت! پس از اولین خرید، امتیاز شما ثبت خواهد شد.`;
                await bot.sendMessage(referrerId, messageForReferrer);
                
                const messageForNewbie = `☀️ خوش آمدید! ☀️\n\nشما توسط <b>${referrerData.first_name || 'دوستتان'}</b> دعوت شده‌اید! برای شروع، روی دکمه زیر کلیک کنید.`;
                const keyboard = { inline_keyboard: [ [{ text: "🔗 دریافت لینک دعوت", callback_data: "request_referral_link" }] ] };
                await bot.sendMessage(userId, messageForNewbie, keyboard);
            
        }
    
    } else if (text === '/mypoints') {
        await sendMyPointsMessage(userId, env, bot);
    }
    
    if (dataChanged) {
        await env.CONTEST_DB.put(`user_${userId}`, JSON.stringify(userData));
    }
}

async function handleChannelPost(post, env, bot) { 
    if (!post || !post.chat || !post.chat.id) return; 
    const receivedChannelId = post.chat.id.toString(); 
    const expectedChannelId = env.REPORT_CHANNEL_ID ? env.REPORT_CHANNEL_ID.trim() : null; 
    if (receivedChannelId !== expectedChannelId) return; 
    const messageText = post.text || ''; 
    if (messageText.includes('#سفارش_جدید') || messageText.includes('#خدمات_ساب')) { 
        const buyerId = parseUserId(messageText); 
        if (!buyerId) return; 
        let buyerData = await env.CONTEST_DB.get(`user_${buyerId}`, { type: 'json' }) || createDefaultUserData(); 
        let pointsEarned = 1; 
        if (!buyerData.first_purchase_done && buyerData.referrer_id) { 
            pointsEarned += 3; 
            const referrerId = buyerData.referrer_id; 
            let referrerData = await env.CONTEST_DB.get(`user_${referrerId}`, { type: 'json' }) || createDefaultUserData(); 
            referrerData.points = (referrerData.points || 0) + 3; 
            referrerData.referrals_who_purchased_count = (referrerData.referrals_who_purchased_count || 0) + 1; 
            await env.CONTEST_DB.put(`user_${referrerId}`, JSON.stringify(referrerData)); 
            const buyerUsername = parseUsername(messageText); 
            const buyerDisplayUsername = buyerUsername ? `@${buyerUsername}` : `کاربر ${buyerId}`; 
            const messageForReferrer = `🎁 تبریک! کاربری که دعوت کرده بودید (${buyerDisplayUsername}) اولین خرید خود را انجام داد و <b>۳ امتیاز</b> به شما اضافه شد!\n/mypoints`; 
            await bot.sendMessage(referrerId, messageForReferrer); 
        } 
        buyerData.points = (buyerData.points || 0) + pointsEarned; 
        buyerData.first_purchase_done = true; 
        const username = parseUsername(messageText); 
        if (username) buyerData.username = username; 
        await env.CONTEST_DB.put(`user_${buyerId}`, JSON.stringify(buyerData)); 
        const keyboard = { inline_keyboard: [ [{ text: "📊 مشاهده آمار امتیازات", callback_data: "show_mypoints" }] ] }; 
        const confirmationMessage = `✅ خرید شما با موفقیت ثبت شد و <b>${pointsEarned} امتیاز</b> دریافت کردید!\n\nمجموع امتیازات: <b>${buyerData.points}</b>`; 
        await bot.sendMessage(buyerId, confirmationMessage, keyboard); 
    } 
}

async function handleCallbackQuery(callbackQuery, env, bot) { 
    const userId = callbackQuery.from.id; 
    const username = callbackQuery.from.username || `user_${userId}`; 
    const firstName = callbackQuery.from.first_name || 'کاربر'; 
    if (callbackQuery.data === 'request_referral_link') { 
        let userData = await env.CONTEST_DB.get(`user_${userId}`, { type: 'json' }) || createDefaultUserData(username, firstName); 
        if (!userData.referral_link) { 
            userData.referral_link = `https://t.me/${env.BOT_USERNAME}?start=${userId}`; 
        } 
        userData.username = username; 
        userData.first_name = firstName; 
        await env.CONTEST_DB.put(`user_${userId}`, JSON.stringify(userData)); 

        const bannerText = `<b>☁️ - آقای مرزبان : پنل ساز خودکار</b>

<i>جامع ترین ربات و اولین پنل ساز هوشمند تحت تلگرام که سعی می‌کند کاهش چشمگیر هزینه هارا برای فروشندگان تجاری و مصارف خانگی به ارمغان بیاورد.</i>
<blockquote>♾️ - <b>امکانات فوق حرفه ای</b>
🚩 - شروع قیمت از 375 تومان 
🔵 - ریستارت پنل مرزبان با یک کلیک
⚡️ - خاموش/روشن کردن تمام اشتراک ها
🌐 - آپ تایم  99% درصدی
🔥 - دیتاسنتر : آلمان-فنلاند-انگلیس-فرانسه
♻️ - بدون نیاز به سرور خارج/ایران
👤 - پشتیبانی فعال و 24 ساعته
🔐 - تغییر پسورد ورود به پنل مرزبان
🏷 - بدون احراز هویت و دردسر</blockquote>
🆕 <b>تست رایگان :</b> یک پنل مرزبان با 15 گیگابایت ترافیک رایگان و انقضا نامحدود از ربات ما دریافت کرده و استفاده کنید. فرصت را از  دست ندهید و همین حالا اقدام کنید... 

📣 - @MarzbanMR
📞 - @MarzbanMRBot`;

        const keyboard = {
            inline_keyboard: [
                [{ text: "🔷 استارت ربات 🔷", url: userData.referral_link }]
            ]
        };

        await bot.sendMessage(userId, bannerText, keyboard);
        
        const linkMessage = `دکمه شیشه ای بالا مجهز به لینک اختصاصی شماست اما با این حال🎉 لینک دعوت اختصاصی شما:

<code>${userData.referral_link}</code>

<i>روی لینک بالا کلیک کنید تا کپی شود</i>`;

        await bot.sendMessage(userId, linkMessage);


    } else if (callbackQuery.data === 'show_mypoints') { 
        await sendMyPointsMessage(userId, env, bot); 
    } 
    await bot.answerCallbackQuery(callbackQuery.id); 
}

async function sendMyPointsMessage(userId, env, bot) {
    const userData = await env.CONTEST_DB.get(`user_${userId}`, { type: 'json' }) || createDefaultUserData();
    const points = userData.points || 0;
    const referrals = userData.referrals_count || 0;
    const purchased_referrals = userData.referrals_who_purchased_count || 0;
    
    const leaderboardBaseUrl = "https://amirrezahoseinabadi.github.io/DASH";
    const webAppUrl = `${leaderboardBaseUrl}?user_id=${userId}`;
    const shareText = encodeURIComponent("امتیاز من در جشنواره بزرگ آقای مرزبان رو ببین! تو هم می‌تونی برنده باشی 🔥");
    const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(webAppUrl)}&text=${shareText}`;

    const keyboard = {
        inline_keyboard: [
            [{ text: "🏆 مشاهده جدول نفرات برتر", web_app: { url: webAppUrl } }],
            [{ text: "🚀 اشتراک‌گذاری امتیاز من", url: shareUrl }]
        ]
    };
    const messageText = `📊 <b>آمار شما در جشنواره</b>:\n\n- 💰 امتیازات: <b>${points}</b>\n- 👥 دعوت‌ها: <b>${referrals}</b>\n- ✅ دعوت‌های موفق: <b>${purchased_referrals}</b>`;
    await bot.sendMessage(userId, messageText, keyboard);
}


function createDefaultUserData(username = '', firstName = '') { 
    return { points: 0, username: username, first_name: firstName, referral_link: '', referrer_id: null, first_purchase_done: false, referrals_count: 0, referrals_who_purchased_count: 0 }; 
}

async function forwardRawBody(originalRequest, rawBody, hostUrl) { 
    try { 
        await fetch(hostUrl, { method: originalRequest.method, headers: originalRequest.headers, body: rawBody, }); 
    } catch (e) { 
        console.error("خطا در فوروارد:", e.toString()); 
    } 
}

class TelegramBot { 
    constructor(token) { 
        this.token = token; 
        this.apiUrl = `https://api.telegram.org/bot${token}`; 
    } 
    async sendMessage(chatId, text, replyMarkup = null) { 
        const payload = { chat_id: chatId, text: text, parse_mode: 'HTML' }; 
        if (replyMarkup) { 
            payload.reply_markup = replyMarkup; 
        } 
        await fetch(`${this.apiUrl}/sendMessage`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), }); 
    } 
    async answerCallbackQuery(callbackQueryId) { 
        await fetch(`${this.apiUrl}/answerCallbackQuery`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ callback_query_id: callbackQueryId }), }); 
    } 
}

function parseUserId(text) { 
    const match = text.match(/(?:id|ایدی عددی فرد)\s*:\s*(\d+)/); 
    return match ? match[1] : null; 
}

function parseUsername(text) { 
    const match = text.match(/آیدی فرد\s*:\s*@(\w+)/); 
    return match ? match[1] : null; 
}
